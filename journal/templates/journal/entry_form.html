{% extends 'journal/base.html' %}

{% block title %}
    {% if form.instance.pk %}Редактировать запись{% else %}Новая запись{% endif %} - Learning Journal
{% endblock %}

<!-- extra_css СНАРУЖИ content -->
{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
<style>
    #id_tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        list-style: none;
        padding: 0;
    }
    
    #id_tags li {
        display: inline-block;
    }
    
    #id_tags input[type="checkbox"] {
        position: absolute;
        opacity: 0;
        pointer-events: none;
    }
    
    #id_tags label {
        display: inline-block;
        padding: 0.4rem 1rem;
        background-color: #6c757d;
        color: white;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 0;
        user-select: none;
    }
    
    #id_tags label:hover {
        background-color: #5a6268;
        transform: scale(1.05);
    }
    
    #id_tags label:has(input:checked) {
        background-color: #28a745 !important;
    }

    /* Тёмная тема для EasyMDE */
    .EasyMDEContainer .CodeMirror {
        background-color: #2b2b2b;
        color: #e0e0e0;
        border-color: #495057;
    }
    
    .EasyMDEContainer .CodeMirror-scroll {
        background-color: #2b2b2b;
    }
    
    .EasyMDEContainer .CodeMirror-gutters {
        background-color: #1e1e1e;
        border-color: #495057;
    }

    .EasyMDEContainer .CodeMirror-cursor {
        border-left: 2px solid #e0e0e0;
    }
    
    .EasyMDEContainer .editor-toolbar {
        background-color: #343a40;
        border-color: #495057;
    }
    
    .EasyMDEContainer .editor-toolbar button {
        color: #e0e0e0 !important;
    }
    
    .EasyMDEContainer .editor-toolbar button:hover {
        background-color: #495057;
    }
    
    .EasyMDEContainer .editor-preview {
        background-color: #2b2b2b;
        color: #e0e0e0;
    }

    .EasyMDEContainer .editor-preview h1,
    .EasyMDEContainer .CodeMirror h1 {
        font-size: 1.75rem !important;
    }
    
    .EasyMDEContainer .editor-preview h2,
    .EasyMDEContainer .CodeMirror h2 {
        font-size: 1.5rem !important;
    }
    
    .EasyMDEContainer .editor-preview h3,
    .EasyMDEContainer .CodeMirror h3 {
        font-size: 1.25rem !important;
    }
    
    .EasyMDEContainer .editor-preview h4,
    .EasyMDEContainer .editor-preview h5,
    .EasyMDEContainer .editor-preview h6 {
        font-size: 1.1rem !important;
    }

</style>
{% endblock %}

<!-- Вот тут начинается content -->
{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-9">
        <div class="card">
            <div class="card-header">
                <h4>{% if form.instance.pk %}Редактировать запись{% else %}Новая запись{% endif %}</h4>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" novalidate>
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Заголовок</label>
                        {{ form.title }}
                        {% if form.title.errors %}
                            <div class="text-danger">{{ form.title.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Категория</label>
                        {{ form.category }}
                        {% if form.category.errors %}
                            <div class="text-danger">{{ form.category.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Теги</label>
                        <div class="d-flex flex-wrap gap-3">
                            {{ form.tags }}
                        </div>
                        {% if form.tags.errors %}
                            <div class="text-danger">{{ form.tags.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Изображение</label>
                        {{ form.image }}
                        {% if form.image.errors %}
                            <div class="text-danger">{{ form.image.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Содержание</label>
                        {{ form.content }}
                        {% if form.content.errors %}
                            <div class="text-danger">{{ form.content.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">Сохранить</button>
                        <a href="{% url 'journal:entry_list' %}" class="btn btn-outline-secondary">Отмена</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let easyMDE = null;  // <- переместили СЮДА, до всех if
    const contentTextarea = document.getElementById('id_content');
    
    if (contentTextarea) {
        easyMDE = new EasyMDE({
            element: contentTextarea,
            spellChecker: false,
            placeholder: "Что изучили сегодня? Используйте Markdown для форматирования.",
            toolbar: [
                "bold", "italic", "heading", "|",
                "quote", "unordered-list", "ordered-list", "|",
                {
                    name: "code",
                    action: function(editor) {
                        const cm = editor.codemirror;
                        const selection = cm.getSelection();
                        cm.replaceSelection("```python\n" + selection + "\n```");
                    },
                    className: "fa fa-code",
                    title: "Code Block (Python)"
                },
                "link", "|",
                "preview", "side-by-side", "fullscreen", "|",
                "guide"
            ]
        });
    }
    
    // Стилизация тегов
    const tagsList = document.getElementById('id_tags');
    if (!tagsList) return;
    
    tagsList.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        const label = checkbox.parentElement.querySelector('label') || 
                      checkbox.nextElementSibling ||
                      checkbox.previousElementSibling;
        
        if (label && label.tagName === 'LABEL') {
            if (checkbox.checked) {
                label.classList.add('active');
            }
            
            label.addEventListener('click', function(e) {
                e.preventDefault();
                checkbox.checked = !checkbox.checked;
                label.classList.toggle('active');
            });
        }
    });
});
</script>
{% endblock %}